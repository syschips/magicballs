# MagicBall - 実装機能一覧

## ゲーム概要

**MagicBall** は、4人対戦のオンライン対応物理シミュレーションボールゲームです。WebRTCによるP2P通信で、リアルタイムに同期しながらプレイできます。

## コアゲーム機能

### 1. 基本ゲームプレイ
- **4人対戦**: 最大4人のプレイヤーが同時対戦
- **物理演算**: リアルな物理挙動でボールが動く
- **マップシステム**: 複数のマップ（ステージ）でプレイ可能
- **タイム制**: 制限時間内にスコアを競う
- **勝敗判定**: スコアに基づく順位決定

### 2. キャラクター（ボール）システム
- **3種類のボールタイプ**:
  - 黒ボール（kuro）
  - 白ボール（shiro）
  - 黄色ボール（kiiro）
- **固有の特性**: 各ボールタイプに異なる物理特性

### 3. プレイヤー操作
- **マウス/タッチ操作**: クリック・ドラッグで移動
- **AI制御**: 人間プレイヤーが不足している場合、CPUが自動参加

## オンライン対戦機能

### 1. 認証システム
- **ユーザー登録**: 新規アカウント作成
- **ログイン**: 既存アカウントでログイン
- **セッション管理**: ログイン状態の維持

### 2. ルーム管理
- **ルーム作成**:
  - ルーム名の設定
  - 最大プレイヤー数の設定（2-6人）
  - ゲーム時間の設定
- **ルーム一覧**: 利用可能なルームの検索・表示
- **ルーム参加**: 既存ルームへの参加
- **ルーム退出**: ゲーム前にルームから退出

### 3. ホスト機能
- **ゲーム開始**: ホストのみがゲームを開始可能
- **ホスト引き継ぎ**: ホストが切断時、自動的に次のプレイヤーに引き継ぎ
- **参加者管理**: 参加プレイヤーの確認

### 4. 準備システム
- **準備状態管理**: 各プレイヤーの準備完了状態を表示
- **全員準備確認**: 全員が準備完了後にゲーム開始可能

### 5. WebRTC通信
- **P2P接続**: プレイヤー間の直接通信
- **リアルタイム同期**: ゲーム状態のリアルタイム共有
- **自動再接続**: 接続が切れた場合の再接続試行
- **接続状態表示**: 各プレイヤーの接続状態を可視化

### 6. チャット機能
- **ルーム内チャット**: 待機中・ゲーム中にテキストチャット
- **システムメッセージ**: 参加/退出などのイベント通知
- **リアルタイム更新**: 自動ポーリングでメッセージ取得

## レーティングシステム

### 1. レート計算
- **初期レート**: 1500
- **勝敗によるレート変動**: Elo レーティングベース
- **履歴記録**: レート変動履歴の保存

### 2. ランキング
- **トップランキング表示**: レート上位プレイヤーの表示
- **統計情報**:
  - 総ゲーム数
  - 勝利数
  - 現在のレート

## UI/UX機能

### 1. 画面遷移
- **認証画面**: ログイン・登録
- **キャラクター選択画面**: ボールタイプ選択
- **ルーム選択画面**: ルーム作成・参加
- **待機ルーム画面**: ゲーム開始待ち
- **ゲーム画面**: プレイ中
- **結果画面**: ゲーム終了時の結果表示

### 2. 通知システム
- **成功通知**: 操作成功時の緑色通知
- **エラー通知**: エラー時の赤色通知
- **情報通知**: 一般情報の青色通知
- **自動消去**: 3秒後に自動的に消える

### 3. ローディング表示
- **ローディングオーバーレイ**: 処理中の表示
- **メッセージ表示**: 処理内容の説明

### 4. ヘルプ表示
- **操作方法**: ゲーム中の操作説明
- **カスタマイズ可能**: 表示/非表示の切り替え

## パーティクルエフェクト

### 1. 視覚効果
- **ボール軌跡**: ボールの移動に伴うパーティクル表示
- **衝突エフェクト**: ボール同士の衝突時のエフェクト
- **スコアエフェクト**: 得点時の視覚的フィードバック

## データ管理

### 1. ゲームデータ
- **状態保存**: ゲーム状態のデータベース保存
- **同期管理**: 複数プレイヤー間での状態同期
- **履歴記録**: ゲーム結果の記録

### 2. セッション管理
- **プレイヤーセッション**: 現在のプレイヤー情報
- **ルームセッション**: 参加中のルーム情報
- **接続状態**: WebRTC接続状態の管理

## 管理機能（バックオフィス）

### 1. ログビューアー
- **ログ一覧表示**: システムログの閲覧
- **検索・フィルター**:
  - ログレベル（ERROR, WARNING, INFO, DEBUG）
  - カテゴリ別
  - プレイヤーID別
  - ルームID別
  - キーワード検索
- **統計情報**: エラー・警告の集計
- **ログ詳細**: JSON データの詳細表示

### 2. 認証
- **管理者ログイン**: ゲームユーザーアカウントで認証
- **セッション管理**: ログイン状態の維持

## エラーハンドリング

### 1. 統合エラーハンドリング
- **エラータイプ分類**:
  - NETWORK: ネットワークエラー
  - AUTH: 認証エラー
  - VALIDATION: バリデーションエラー
  - WEBRTC: WebRTC接続エラー
  - GAME: ゲームロジックエラー
- **エラー記録**: データベースへの自動記録
- **ユーザー通知**: わかりやすいエラーメッセージ

### 2. 自動回復
- **再接続**: 接続断時の自動再接続
- **フォールバック**: WebRTC失敗時のフォールバック処理
- **ホスト移行**: ホスト切断時の自動移行

## セキュリティ機能

### 1. 認証・認可
- **パスワードハッシュ化**: bcrypt によるパスワード保護
- **セッション管理**: セキュアなセッション管理
- **SQL インジェクション対策**: プリペアドステートメント使用

### 2. データ検証
- **入力バリデーション**: すべての入力データの検証
- **XSS 対策**: HTML エスケープ処理
- **CSRF 対策**: トークンベース認証（実装推奨）

## パフォーマンス最適化

### 1. ネットワーク最適化
- **ポーリング間隔調整**: 適切なポーリング頻度
- **データ圧縮**: 必要最小限のデータ送信
- **接続プーリング**: データベース接続の再利用

### 2. レンダリング最適化
- **Canvas 描画**: 効率的な Canvas API 使用
- **パーティクル制限**: パーティクル数の制限
- **フレームレート管理**: 一定のフレームレート維持

## 開発者向け機能

### 1. デバッグ機能
- **コンソールログ**: 詳細なデバッグログ
- **状態表示**: ゲーム内部状態の可視化
- **エラートラッキング**: エラーの追跡・記録

### 2. 開発ツール
- **ESLint**: コード品質チェック
- **JSDoc**: 型注釈とドキュメンテーション
- **エラーハンドラー**: 統一されたエラー処理

## 今後の拡張可能性

### 検討中の機能
- カスタムマップエディタ
- トーナメントモード
- リプレイ機能
- スキン・カスタマイズ
- アチーブメントシステム
- フレンドシステム
- プライベートマッチ
- 観戦モード

## 技術スタック

- **フロントエンド**: Vanilla JavaScript, HTML5 Canvas
- **バックエンド**: PHP 7.4+
- **データベース**: MySQL 5.7+
- **通信**: WebRTC (P2P), HTTP REST API
- **認証**: セッションベース認証
- **リアルタイム通信**: ポーリング + WebRTC DataChannel

## ブラウザ対応

- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+
- モバイルブラウザ（iOS Safari, Chrome Mobile）
